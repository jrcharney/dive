<!doctype html>
<html lang="en">
  <head>
    <title>Dive: GTFS Local Search</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <style type="text/css">
      #map {
        width:800px;  /* Aspect Ratio! */
        height:600px;
      }
    </style>
  </head>
  <body>
    <!-- TODO: put the form before the map -->
    <!-- TODO: list search results after teh map div -->
    <!-- TODO: can the select element be a single line? -->
    <!-- TODO: SEO-ify the input field that I added to replace the select element. -->
    <div id="map"></div>
    <div>I'm on the
      <select id="bus-routes">

      </select>
       looking for
      <input name="things" id="things" value=""> <!-- Let's not limit our search to two specific queries -->
      <!--
      <select id="things">
        <option>bar</option>
        <option>pharmacy</option>
      </select>
      -->
      <button id="find-things">Find it!</button>
      <!-- TODO: Advanced options.
      What if I want to catch a bus at another time or be somewhere at a specific time?
      What if I wanted to stop at several places? (Multiroute!)
      -->
    </div>
    <!-- TODO: Isn't there a single line for jQuery? Use that. -->
    <!-- TODO: All these Scripts need to go in the header! -->
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    
    <!-- TODO: Can we move this part to an external file? -->
    <script type="text/javascript">
      var map = L.map('map'),
          route_stop_coords = [],
          query_near_route_api = 'http://metro-stl-routes-venues-api.herokuapp.com/routes/',
          markers;

      function setMapToCurrentLocation(data) {
        var latitude = data.coords['latitude'];
        var longitude = data.coords['longitude'];
        map.setView([latitude, longitude], 13);

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
      }

      function handleJsonResponse(stops) {
        for (stop in stops) {
          var stop_location = stops[stop]['stop_location'];
          route_stop_coords.push([stop_location['lat'], stop_location['long']]);
          console.log()
          stop_venues = stops[stop]['venues'];
          for(var i=0;i<stop_venues.length;i++) {
            var latitude = stop_venues[i].location.lat;
            var longitude = stop_venues[i].location.lng;
            L.marker([latitude, longitude]).addTo(map)
              .bindPopup(stop_venues[i].name)
              .openPopup();
          }
        }

        var polyline = L.polyline(route_stop_coords, {color: 'red'}).addTo(map);
        map.fitBounds(polyline.getBounds());
      }

      function loadRoutesIntoSelect() {
        var routes = [];
        $.getJSON('http://www.corsproxy.com/gtfs-api.herokuapp.com/api/routes/metro-st-louis',
          function(data) {
            for (route in data) {
              route = data[route];
              routes.push(route);
            }

            $.each(routes, function(route) {
              var route_option;
              route = routes[route];
              bus_route_text = route['route_short_name'] + ' - ' + route['route_long_name'];

              route_option = $('<option></option>').attr('value',route['route_id']).text(bus_route_text);

              $('select#bus-routes').append(route_option);
            });
        });
      }

      function findThingsWithSelection() {
        var route = $('select#bus-routes').val(),
            thing = 'bar', //$('select#things').val(),    // TODO: $('input#things').val()?
            url;

        clearMap();

        url = query_near_route_api + route + '?query=' + thing;

        console.log(url);
        $.getJSON(url, handleJsonResponse);
      }

      function clearMap() {
        route_stop_coords = [];
        for(i in map._layers) {
            if(map._layers[i]._url != "http://{s}.tile.osm.org/{z}/{x}/{y}.png") {
                try {
                    map.removeLayer(map._layers[i]);
                }
                catch(e) {
                    console.log("problem with " + e + map._layers[i]);
                }
            }
        }
      }
      $(document).ready(function(){
        navigator.geolocation.getCurrentPosition(setMapToCurrentLocation);
        $('button#find-things').click(findThingsWithSelection);
        loadRoutesIntoSelect();
      });
    </script>
  </body>
</html>
